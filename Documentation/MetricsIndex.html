<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Silica Metrics Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background:#1e1e1e; color:#e0e0e0; font-family:"Segoe UI",Arial,sans-serif; margin:0; }
    header { background:#2d2d2d; padding:1rem 2rem; }
    h1 { margin:0; font-size:1.4rem; }
    .controls { margin:1rem 2rem; }
    button {
      background:#0078d7; color:#fff; border:none; border-radius:4px;
      padding:0.5rem 1.2rem; margin-right:0.5rem; font-size:0.95rem; cursor:pointer;
    }
    button:hover { background:#005a9e; }
    #metricsTable {
      width:96%; margin:1rem 2%; border-collapse:collapse; background:#252526;
      border-radius:6px; overflow:hidden;
    }
    #metricsTable th, #metricsTable td {
      padding:0.4em 0.7em; border-bottom:1px solid #333; text-align:left;
    }
    #metricsTable th { background:#222; }
    #metricsTable tr:last-child td { border-bottom:none; }
    .tags { color:#b8bb26; font-size:0.9em; }
    .gauge {
      height:1em; border-radius:4px; background:#333; position:relative; width:150px;
    }
    .gauge-fill {
      height:100%; border-radius:4px; background:#0078d7; width:0%;
      transition:width 0.3s ease;
    }
    .gauge-label {
      font-size:0.85em; margin-left:0.5em; color:#ccc;
    }
  </style>
</head>
<body>
  <header>
    <h1>Silica Metrics Dashboard</h1>
  </header>
  <div class="controls">
    <button onclick="loadMetrics()">Refresh Metrics</button>
    <button onclick="clearMetrics()">Clear</button>
    <span id="metricCount" style="margin-left:1em; color:#aaa;"></span>
  </div>
  <table id="metricsTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Latest Value</th>
        <th>Gauge</th>
        <th>Tags</th>
      </tr>
    </thead>
    <tbody id="metricsBody">
      <tr><td colspan="5">Loading...</td></tr>
    </tbody>
  </table>

  <script>
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>\"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function renderTags(tags) {
      if (!tags) return '';
      // Case 1: array of {Key, Value} or {key, value}
      if (Array.isArray(tags)) {
        return tags.map(t => {
          const k = t.Key || t.key;
          const v = t.Value || t.value;
          return `${escapeHtml(k)}=${escapeHtml(String(v))}`;
        }).join(', ');
      }
      // Case 2: object/dictionary { "component": "TestApp", "region": "dev" }
      if (typeof tags === 'object') {
        return Object.entries(tags)
          .map(([k, v]) => `${escapeHtml(k)}=${escapeHtml(String(v))}`)
          .join(', ');
      }
      return '';
    }

    function renderGauge(value, max=100) {
      if (typeof value !== 'number' || isNaN(value)) return '';
      const pct = Math.min(100, (value/max)*100);
      return `<div class="gauge"><div class="gauge-fill" style="width:${pct}%"></div></div>
              <span class="gauge-label">${value.toFixed(2)}</span>`;
    }

    async function loadMetrics() {
      const body = document.getElementById('metricsBody');
      const count = document.getElementById('metricCount');
      body.innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;
      try {
        const res = await fetch('/api/metrics');
        if (!res.ok) {
          body.innerHTML = `<tr><td colspan="5">Failed to load metrics: ${res.status}</td></tr>`;
          count.textContent = '';
          return;
        }
        const metrics = await res.json();
        if (!metrics || metrics.length === 0) {
          body.innerHTML = `<tr><td colspan="5">No metrics available.</td></tr>`;
          count.textContent = '';
          return;
        }
        // Group by metric name, keep latest
        const latest = {};
        for (const m of metrics) {
          latest[m.name] = m;
        }
        let rows = '';
        for (const name in latest) {
          const m = latest[name];
          const type = escapeHtml(m.type || '');
          const value = Number(m.value);
          const tags = m.tags || [];
          rows += `<tr>
            <td>${escapeHtml(name)}</td>
            <td>${type}</td>
            <td>${isNaN(value) ? '' : value}</td>
            <td>${renderGauge(value, type.toLowerCase()==='counter'?1000:100)}</td>
            <td class="tags">${renderTags(tags)}</td>
          </tr>`;
        }
        body.innerHTML = rows;
        count.textContent = Object.keys(latest).length + ' metrics';
      } catch (e) {
        body.innerHTML = `<tr><td colspan="5">Error loading metrics: ${escapeHtml(e.message||e)}</td></tr>`;
        count.textContent = '';
      }
    }

    function clearMetrics() {
      document.getElementById('metricsBody').innerHTML = '';
      document.getElementById('metricCount').textContent = '';
    }

    window.onload = loadMetrics;
  </script>
</body>
</html>
